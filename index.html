<!DOCTYPE html>
<html>

<head>
    <meta charset=urf-8/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=yes' />
    <title>San Francisco Car Break-ins Crime Map</title>
    <link rel='stylesheet' href='http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css' />
    <script src='http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js'></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
</head>
<style>
body {
    margin: 0;
    padding: 0;
}

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

#control {
    position: absolute;
    top: 5px;
    right: 10px;
    color: white;
    font-family: Georgia;
    font-size: small;
    padding-left: 20px;
    padding-right: 20px;
    background-color: rgba(0, 0, 0, 0.5);
}
</style>

<body>
    <div id='map'></div>
    <script>
    // get geolocation from the web-browser
    function main() {

        navigator.geolocation.getCurrentPosition(GetLocation);

        function GetLocation(location) {

            var map = new L.map('map').setView([37.77, -122.41], 12);
            L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var lat = location.coords.latitude;
            var lon = location.coords.longitude;

            // draw a marker based on user's current location 
            var marker = L.marker([lat, lon]).addTo(map);

            // marker.style.background-color = "red";

            var sublayer;

            cartodb.createLayer(map, {
                    user_name: "jqzhang",
                    type: 'cartodb',
                    sublayers: [{
                        sql: "SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year' ORDER BY incdate DESC",
                        cartocss: '#yvry {marker-fill: red; marker-width: 5; marker-line-color: #FFF; marker-line-width: .5; opacity: .6; }',
                        interactivity:"cartodb_id, latitude, longitude",

                    }]
                })
                .addTo(map)
                .done(function(layer) {
                    var v = cdb.vis.Overlay.create('search', map.viz, {})
                    v.show();
                    $('#map').append(v.render().el);
                    sublayer = layer.getSubLayer(0);
                    sublayer.setInteraction(true);
                    addCursorInteraction(sublayer);

                });


            // var sublayers = [];

            // cartodb.createLayer(map, layerUrl)
            // .addTo(map)
            // .on('done', function(layer) {

            // var v = cdb.vis.Overlay.create('search', map.viz, {})
            // v.show();
            // $('#map').append(v.render().el);

            // // filter not working yet...
            // var sql = new cartodb.SQL({ user: 'jqzhang' });

            // sql.execute("SELECT * FROM yvry WHERE date ILIKE '%2015%'")
            // .done(function(data) {
            // console.log(data.rows);
            // })
            // .error(function(errors) {
            // // errors contains a list of errors
            // console.log("errors:" + errors);
            // })

        };

    };

    window.onload = main;
    </script>
</body>

</html>