<!DOCTYPE html>
<html>

<head>
    <meta charset=urf-8/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=yes' />
    <title>San Francisco Car Break-ins Crime Map</title>
    <link rel='stylesheet' href='http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css' />
    <script src='http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js'></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,300' rel='stylesheet' type='text/css'>
</head>
<style>
body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', 'Helvetica', sans-serif;
    font-weight: 300;
}

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

#control {
    position: absolute;
    top: 5px;
    right: 10px;
    color: white;
    font-family: Georgia;
    font-size: small;
    padding-left: 20px;
    padding-right: 20px;
    background-color: rgba(0, 0, 0, 0.5);
}

#bkcard {
    background-color: rgba(0, 0, 0, .8);
    /*border-radius: 5px;*/
    position: absolute;
    right: 0px;
    width: 350px;
    height: 100%;
    z-index: 0;
    color: white;
    overflow-y: scroll;
}

#bkcard h2 {
    color: white;
    padding-left: 20px;
    margin-bottom: 0px;
    font-size: 25px;
}

#bkcard h3 {
    color: white;
    padding-left: 20px;
    font-weight: 400;
}

#bkcard h4 {
    color: white;
    padding-left: 20px;
    padding-top: 0px;
}

#bkcard h5 {
    color: white;
    font-size: 10px;
    padding-left: 20px;
    padding-top: 0px;
    font-weight: 300;
}

#bkcard p {
    color: white;
    font-size: 12px;
    padding-left: 20px;
    padding-top: 0px;
    font-weight: 300;
    padding-right: 20px;
}

#bkcard #credit {
    font-size: 12px;
}

div.cartodb-searchbox {
    position: absolute;
    top: 90px;
    left: 20px;
    z-index: 99 !important;
}

#switch_off {
    margin: 15px 10px 0 0;
    position: absolute;
    left: 50px;
    top: -5px;
    vertical-align: baseline;
    width: 100px;
    padding: 12px;
    text-align: center;
    font: bold 12px "Helvetica", Arial;
    line-height: normal;
    color: #555;
    border-radius: 4px;
    border: 1px solid lightgrey;
    text-decoration: none;
    cursor: pointer;
    background: white;
    box-shadow: 2px 2px 2px 2px darkgrey;
    outline: none;
}

#switch_off.selected,
#switch_off:hover {
    color: steelblue;
}

#menu {
    background: transparent;
    z-index: 10;
    padding-left: 20px;
}

#menu a {
    margin: 15px 10px 0 0;
    float: left;
    vertical-align: baseline;
    width: 125px;
    padding: 10px;
    text-align: center;
    font: bold 8px "Helvetica", Arial;
    line-height: normal;
    color: #555;
    border-radius: 4px;
    border: 1px solid #777777;
    background: #ffffff;
    text-decoration: none;
    cursor: pointer;
}

#menu a.selected,
#menu a:hover {
    color: steelblue;
}

path.leaflet-clickable {
    fill: black;
    stroke: black;
    opacity: 1;
}

#map {
    z-index: -1;
}

#power-gauge1 {
    padding-left: 50px;
}

#power-gauge2 {
    padding-left: 50px;
}

#power-gauge1 g.pointer {
    fill: white;
    stroke: lightgrey;
}

#power-gauge2 g.pointer {
    fill: white;
    stroke: lightgrey;
}

#power-gauge1 g.label text {
    text-anchor: middle;
    font-size: 10px;
    font-weight: bold;
    fill: white;
}

#power-gauge2 g.label text {
    text-anchor: middle;
    font-size: 10px;
    font-weight: bold;
    fill: white;
}

#gauges {
    float: left;
}
</style>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<body>
    <div id='map'></div>
    <a id="switch_off" class="button switch_off">HIDE THE CITY LAYER</a>
    <div id="bkcard">
        <h2>HOW SAFE IS IT TO PARK?</h2>
        <h4>A Live San Francisco Car Break-ins Map</h4>
        <p id="credit">By Jieqian Zhang</p>
        <p>This tool uses car break-in crime data from the San Francisco Police Department Incident Reporting system. The dataset behind the map is updated daily. While the full dataset goes back to 2003, this map is set to visualize data from the past year.</p>
        <p><strong>Instructions:</strong> </p>
        <p>click on the button below to see break-ins near you.</p>
        <div id='menu' onclick="detectUserLocation()">
            <a id="detect">FIND BREAK-INS NEAR YOU</a>
        </div>
        <div id="gauges">
            <h4> Break-ins near you:</h4>
            <div id="power-gauge2"></div>
            <h4> City-wide average break-ins:</h4>
            <div id="power-gauge1"></div>
            <h3>Methodology</h3>
            <p> The "Break-ins near you" map above represents the number of break-ins for a circular area with a 282 meter radius (a quarter square kilometer) around your current location. The "City-wide average break-ins" number represents the average number of break-ins in all of San Francisco for the equivalent area. We calculate these numbers by counting the number of incidents in the past year from San Francisco Police Department Incident Reporting Data, with the beginning date updating daily. 
            <h5>*Built with CartoDB.js, PostGIS and d3.js.</h5>
        </div>
    </div>
    <script>
    var map = new L.map('map').setView([37.76, -122.395], 12);
    // L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);


    var sublayer;


    var sql = new cartodb.SQL({
        user: 'jqzhang',
        format: 'json'
    });


    cartodb.createLayer(map, {
            user_name: "jqzhang",
            type: 'cartodb',
            sublayers: [{
                sql: "WITH crimes AS (SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year') SELECT neighborhoods_areas.the_geom_webmercator,neighborhoods_areas.neighborho, count(crimes.the_geom_webmercator) *10000 /neighborhoods_areas.area AS rate FROM neighborhoods_areas, crimes WHERE ST_Contains(neighborhoods_areas.the_geom_webmercator, crimes.the_geom_webmercator) GROUP BY neighborhoods_areas.the_geom_webmercator, neighborhoods_areas.neighborho, neighborhoods_areas.area",
                cartocss: "#yvry{polygon-fill: #FFFFB2; polygon-opacity: 0.8;line-color: #FFF;line-width: 0.5;line-opacity: 1;}#yvry[rate<=13.4502033352671]{polygon-fill: #b2182b;}#yvry[rate<=7.96100602097922]{polygon-fill: #ef8a62;}#yvry[rate<=2.24165005995164]{polygon-fill: #fddbc7;}#yvry[rate<=1.48236717330872]{polygon-fill: #f7f7f7;}#yvry[rate<=0.734503065922202]{polygon-fill: #c7eae5;}#yvry[rate<=0.620246533008774]{polygon-fill: #5ab4ac;}#yvry[rate<=0.447005419095189]{polygon-fill: #01665e;}",
            }]
        })
        .addTo(map, 2)
        .done(function(layer) {
            // var v = cdb.vis.Overlay.create('search', map.viz, {})
            // v.show();
            // $('#bkcard').append(v.render().el);    

            //     var cssStyle = [ 
            //             '#yvry{',
            //               'polygon-fill: #FFEDA0;',
            //               'polygon-opacity: 0.8;',
            //               'line-color: #FFF;',
            //               'line-width: 0.5;',
            //               'line-opacity: 1;',
            //             '}',
            //             '#yvry [rate <= 12] {',
            //               'polygon-fill: #F03B20;',
            //             '}',
            //             '#yvry [rate <= 6] {',
            //                'polygon-fill: #FEB24C;',
            //             '}',
            //             '#yvry [ rate <= 1] {',
            //                'polygon-fill: #FFEDA0;',
            //             '}'
            //   ].join("\n");

            // layer.setCartoCSS(cssStyle);


            $("#switch_off").click(function() {
                if (this.text == "HIDE THE CITY LAYER") {
                    document.getElementById("switch_off").innerHTML = "SHOW THE CITY LAYER";
                    layer.getSubLayer(0).hide();
                } else if (this.text == "SHOW THE CITY LAYER") {
                    document.getElementById("switch_off").innerHTML = "HIDE THE CITY LAYER";
                    layer.getSubLayer(0).show();
                }
            })
        })
        .on('error', function() {
            //log the error
        });





    // ************************************************************************************* calculate the crime rate per m2 in the entire city  &&&&&  create a buffer and calculate the crime rate within 1 km radius of the user's location *****************************************************************//


    // get geolocation from the web-browser
    function mapToPosition(position) {
        console.log("position", position);

        var lon = position.coords.longitude;
        var lat = position.coords.latitude;
        // map.setView(new L.LatLng(lat, lon), 15);
        map.setView([37.779272, -122.4193494], 15)
            // new L.CircleMarker([lat, lon], {
        new L.CircleMarker([37.779272, -122.4193494], {
            radius: 5
        }).addTo(map);


        // create a buffer
        cartodb.createLayer(map, {
                user_name: "jqzhang",
                type: 'cartodb',
                sublayers: [{
                    // sql: "SELECT ST_Transform(ST_Buffer(CDB_LatLng(" + lat + "," + lon + ")::geography,1000)::geometry, 3857) AS the_geom_webmercator, 1 AS cartodb_id",
                    sql: "SELECT ST_Transform(ST_Buffer(CDB_LatLng(37.779272, -122.4193494)::geography,282)::geometry, 3857) AS the_geom_webmercator, 1 AS cartodb_id",
                    cartocss: '#yvry{polygon-fill: white; polygon-opacity: 0.2;line-color: black;line-width: 2; line-opacity: 8;}',
                }]
            })
            .addTo(map, 3);


        //calculate the crime rate per m2 in the entire city

        sql.execute("SELECT (SELECT COUNT(cartodb_id) FROM (SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year') AS year_crime) * 10000 /(SELECT SUM(area) FROM neighborhoods_areas) AS city_crime_rate")
            .done(function(data) {

                var city_crime_rate = data.rows[0].city_crime_rate;
                powerGauge1.update(city_crime_rate);



            });




        // calculate the crime rate within 1 km radius of the user


        // sql.execute("WITH crimes AS (SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year'), buffer AS (SELECT ST_Buffer(CDB_LatLng(" + lat + "," + lon + ")::geography,100)::geometry AS the_geom) SELECT COUNT(cartodb_id) * 10000 /(SELECT ST_AREA(buffer.the_geom::geography) FROM buffer) AS loc_crime_rate FROM crimes, buffer WHERE ST_Intersects(crimes.the_geom, buffer.the_geom)")
        sql.execute("WITH crimes AS (SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year'), buffer AS (SELECT ST_Buffer(CDB_LatLng(37.779272, -122.4193494)::geography,282)::geometry AS the_geom) SELECT COUNT(cartodb_id) * 10000 /(SELECT ST_AREA(buffer.the_geom::geography) FROM buffer) AS loc_crime_rate FROM crimes, buffer WHERE ST_Intersects(crimes.the_geom, buffer.the_geom)")
            .done(function(data) {

                var loc_crime_rate = data.rows[0].loc_crime_rate;
                powerGauge2.update(loc_crime_rate);
            });


    };



    // cartodb.createLayer(map, {
    //         user_name: "jqzhang",
    //         type: 'cartodb',
    //         sublayers: [{
    //             sql: "WITH crimes AS (SELECT * FROM (SELECT *, to_date(date, 'MM/DD/YYYY') AS incdate FROM yvry) AS crimes WHERE incdate >= now() - interval '1 year'), buffer AS (SELECT ST_Buffer(CDB_LatLng(" + lat + "," + lon + ")::geography,1000)::geometry AS the_geom) SELECT buffer.the_geom AS the_geom_webmercator, ST_Transform(buffer.the_geom, 3857) AS the_geom_webmercator, COUNT(cartodb_id)/(SELECT ST_AREA(buffer.the_geom::geography) FROM buffer) AS loc_crime_rate, 1 as cartodb_id FROM crimes, buffer WHERE ST_Intersects(crimes.the_geom, buffer.the_geom) GROUP BY buffer.the_geom",
    //             cartocss: '#yvry{polygon-fill: orange; polygon-opacity: 0.5;line-color: darkgrey;line-width: 0.5; line-opacity: 1;}',
    //         }]
    //     })
    //     .addTo(map, 0);
    // };


    function alertError(error) {
        mapToPosition({
            coords: {
                latitude: 37.779272,
                longitude: -122.4193494
            }
        });
    }


    function detectUserLocation() {
        if (navigator.geolocation) {
            var timeoutVal = 10 * 1000 * 1000;
            navigator.geolocation.getCurrentPosition(
                mapToPosition,
                alertError, {
                    enableHighAccuracy: true,
                    timeout: timeoutVal,
                    maximumAge: 0
                }
            );
        } else {
            alert("Geolocation is not supported by this browser");
        }


    };


    // function alertError(error) {
    //     mapToPosition({
    //         coords: {
    //             latitude: 37.779272,
    //             longitude: -122.4193494
    //         }
    //     });
    // }


    // function detectUserLocation() {
    //     var timeoutVal = 5000;
    //     if (navigator.geolocation) {           
    //         console.log("has geo location");
    //         navigator.geolocation.getCurrentPosition(
    //             mapToPosition,
    //             alertError, {
    //                 enableHighAccuracy: true,
    //                 timeout: timeoutVal,
    //                 maximumAge: 0
    //             }
    //         );
    //     } else {
    //         alert("Geolocation is not supported by this browser");
    //     }
    // };
    </script>
    <!--  *******************************************************************************************************draw two half gauges**************************************************************************************** this graphic is modified from msqr's block http://bl.ocks.org/msqr/3202712 ************************** -->
    <script>
    var gauge = function(container, configuration) {
        var that = {};
        var config = {
            size: 200,
            clipWidth: 200,
            clipHeight: 110,
            ringInset: 15,
            ringWidth: 20,

            pointerWidth: 10,
            pointerTailLength: 7,
            pointerHeadLengthPercent: 0.9,

            minValue: 0,
            maxValue: 14,

            minAngle: -90,
            maxAngle: 90,

            transitionMs: 750,

            majorTicks: 7,
            labelFormat: d3.format(',g'),
            labelInset: 10,

            arcColorFn: ["#01665e", "#5ab4ac", "#c7eae5", "#f7f7f7", "#fddbc7", "#ef8a62", "#b2182b"]

        };
        var range = undefined;
        var r = undefined;
        var pointerHeadLength = undefined;
        var value = 0;

        var svg = undefined;
        var arc = undefined;
        var scale = undefined;
        var ticks = undefined;
        var tickData = undefined;
        var pointer = undefined;

        var donut = d3.layout.pie();

        function deg2rad(deg) {
            return deg * Math.PI / 180;
        }

        function newAngle(d) {
            var ratio = scale(d);
            var newAngle = config.minAngle + (ratio * range);
            return newAngle;
        }

        function configure(configuration) {
            var prop = undefined;
            for (prop in configuration) {
                config[prop] = configuration[prop];
            }

            range = config.maxAngle - config.minAngle;
            r = config.size / 2;
            pointerHeadLength = Math.round(r * config.pointerHeadLengthPercent);

            // a linear scale that maps domain values to a percent from 0..1
            scale = d3.scale.linear()
                .range([0, 1])
                .domain([config.minValue, config.maxValue]);

            ticks = scale.ticks(config.majorTicks);
            tickData = d3.range(config.majorTicks).map(function() {
                return 1 / config.majorTicks;
            });

            arc = d3.svg.arc()
                .innerRadius(r - config.ringWidth - config.ringInset)
                .outerRadius(r - config.ringInset)
                .startAngle(function(d, i) {
                    var ratio = d * i;
                    return deg2rad(config.minAngle + (ratio * range));
                })
                .endAngle(function(d, i) {
                    var ratio = d * (i + 1);
                    return deg2rad(config.minAngle + (ratio * range));
                });
        }
        that.configure = configure;

        function centerTranslation() {
            return 'translate(' + r + ',' + r + ')';
        }

        function isRendered() {
            return (svg !== undefined);
        }
        that.isRendered = isRendered;

        function render(newValue) {
            svg = d3.select(container)
                .append('svg:svg')
                .attr('class', 'gauge')
                .attr('width', config.clipWidth)
                .attr('height', config.clipHeight);

            var centerTx = centerTranslation();

            var arcs = svg.append('g')
                .attr('class', 'arc')
                .attr('transform', centerTx);

            arcs.selectAll('path')
                .data(tickData)
                .enter().append('path')
                .attr('fill', function(d, i) {
                    return config.arcColorFn[i];
                })
                .attr('d', arc);

            var lg = svg.append('g')
                .attr('class', 'label')
                .attr('transform', centerTx);
            lg.selectAll('text')
                .data(ticks)
                .enter().append('text')
                .attr('transform', function(d) {
                    var ratio = scale(d);
                    var newAngle = config.minAngle + (ratio * range);
                    return 'rotate(' + newAngle + ') translate(0,' + (config.labelInset - r) + ')';
                })
                .text(config.labelFormat);

            var lineData = [
                [config.pointerWidth / 2, 0],
                [0, -pointerHeadLength],
                [-(config.pointerWidth / 2), 0],
                [0, config.pointerTailLength],
                [config.pointerWidth / 2, 0]
            ];
            var pointerLine = d3.svg.line().interpolate('monotone');
            var pg = svg.append('g').data([lineData])
                .attr('class', 'pointer')
                .attr('transform', centerTx);

            pointer = pg.append('path')
                .attr('d', pointerLine /*function(d) { return pointerLine(d) +'Z';}*/ )
                .attr('transform', 'rotate(' + config.minAngle + ')');

            update(newValue === undefined ? 0 : newValue);
        }
        that.render = render;

        function update(newValue, newConfiguration) {
            if (newConfiguration !== undefined) {
                configure(newConfiguration);
            }
            var ratio = scale(newValue);
            var newAngle = config.minAngle + (ratio * range);
            pointer.transition()
                .duration(config.transitionMs)
                .ease('elastic')
                .attr('transform', 'rotate(' + newAngle + ')');
        }
        that.update = update;

        configure(configuration);

        return that;
    };
    </script>
    <script>
    var powerGauge1;
    var powerGauge2;

    function onDocumentReady() {
        powerGauge1 = gauge('#power-gauge1', {
            size: 180,
            clipWidth: 200,
            clipHeight: 120,
            ringWidth: 30,
            maxValue: 14,
            transitionMs: 4000,
        });
        powerGauge1.render();

        powerGauge2 = gauge('#power-gauge2', {
            size: 180,
            clipWidth: 200,
            clipHeight: 120,
            ringWidth: 30,
            maxValue: 14,
            transitionMs: 4000,
        });
        powerGauge2.render();

    }


    if (!window.isLoaded) {
        window.addEventListener("load", function() {
            onDocumentReady();
        }, false);
    } else {
        onDocumentReady();
    }
    </script>
</body>

</html>
